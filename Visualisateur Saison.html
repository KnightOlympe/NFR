<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>NWFA Nations Cup - Visualisateur Officiel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:'Segoe UI',Arial,sans-serif;background:#f3f5fa;color:#222;margin:0;padding:0;min-height:100vh}
    .container{max-width:1400px;margin:35px auto;background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,0.02);padding:32px;overflow-x:auto}
    h1,h2,h3{text-align:center;margin-bottom:10px;letter-spacing:1px;color:#1c3a72}
    h1{font-size:2.2em;font-weight:800;margin-bottom:25px}
    h2{font-size:1.6em;margin:45px 0 25px 0;border-bottom:3px solid #e5ecfa;padding-bottom:10px}
    h3{font-size:1.3em;margin:25px 0 15px}
    h4{font-size:1.15em;margin:20px 0 12px;color:#1c3a72}
    .phase-section{margin-bottom:50px}
    .confederation-header{padding:15px 20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:10px;margin:25px 0 15px;font-weight:600}
    .classement-table{border-collapse:collapse;width:100%;margin:15px 0;font-size:1.05em;min-width:750px;background:#f6f9fe;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.01)}
    .classement-table th,.classement-table td{padding:10px 8px;text-align:center;border-bottom:1px solid #e2e8f0}
    .classement-table th{background:#e5ecfa;color:#1a253a;font-weight:700;font-size:1em;letter-spacing:0.5px}
    .classement-table tr{transition:background 0.2s}
    .classement-table tr:hover{background:#e9f3ff}
    .points{font-weight:800;color:#1c3a72}

    /* Couleurs par conf√©d√©ration */
    .qualif-cath th{background:#7f6000 !important;color:white}
    .qualif-cath td.qualifie{background:#ffe599 !important}
    .qualif-idy th{background:#274e13 !important;color:white}
    .qualif-idy td.qualifie{background:#b6d7a8 !important}
    .qualif-ire th{background:#741b47 !important;color:white}
    .qualif-ire td.qualifie{background:#d5a6bd !important}
    .qualif-nw th{background:#b45f06 !important;color:white}
    .qualif-nw td.qualifie{background:#f9cb9c !important}
    .qualif-pho th{background:#073763 !important;color:white}
    .qualif-pho td.qualifie{background:#a4c2f4 !important}

    /* Phase groupes */
    .groupes td.qualifie{background:#a4c2f4 !important}

    /* Phase finale */
    td.parcours-vainqueur{background:#93c47d !important}
    td.parcours-finaliste{background:#b6d7a8 !important}
    td.parcours-demi{background:#f6b26b !important}
    td.parcours-quarts{background:#eecc99 !important}
    td.parcours-huitiemes{background:#ffff75 !important}
    td.parcours-seiziemes{background:#fcfc99 !important}

    .matches-section{margin-top:15px;padding:15px;background:#f8fbff;border-radius:8px;border-left:4px solid #2676e3;display:none}
    .matches-section.active{display:block}
    .match-table{width:100%;border-collapse:collapse;font-size:0.95em;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
    .match-table th{background:#e5ecfa;padding:10px 8px;font-weight:600}
    .match-table td{padding:8px 6px;border-bottom:1px solid #eee;text-align:center}
    .match-win{color:#2ea851;font-weight:bold}
    .match-loss{color:#e85d5d}
    .match-draw{color:#ffd700}

    .btn{background:#2676e3;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:1em;margin:4px 2px;cursor:pointer;transition:background 0.2s;display:inline-block}
    .btn:hover{background:#154a9b}
    .btn.active{background:#2ea851}
    .btn.active:hover{background:#1f7a3a}
    .import-section{text-align:center;margin:30px 0;padding:20px;background:rgba(255,255,255,0.5);border-radius:12px}
    .phase-separator{margin:60px 0 30px;height:4px;background:linear-gradient(90deg,#1c3a72,#4a90e2);border-radius:2px}
  </style>
</head>
<body>
<div class="container">
  <h1>üèÜ NWFA Nations Cup - Visualisateur Complet</h1>

  <div class="import-section">
    <label class="btn">üìÅ Importer JSON
      <input id="json-input" type="file" accept=".json" style="display:none">
    </label>
    <div id="status" style="margin-top:10px;font-weight:500"></div>
  </div>

  <div id="content"></div>
</div>

<script>
  let data = null;
  let groupMatches = {}; // Cache des matchs par groupe

  document.getElementById('json-input').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const json = JSON.parse(evt.target.result);
        data = json.teams && json.matches ? json : convertToMatchFormat(json);
        document.getElementById('status').innerHTML = `‚úÖ ${data.matches.length} matchs ‚Ä¢ ${data.teams.length} √©quipes charg√©es`;
        groupMatches = {};
        renderAll();
      } catch(err) {
        document.getElementById('status').innerHTML = `‚ùå Erreur JSON: ${err.message}`;
      }
      e.target.value = '';
    };
    reader.readAsText(file);
  });

  function convertToMatchFormat(json) {
    return {
      teams: json.equipes?.map(n => ({nom: n})) || [],
      matches: json.matchs?.map(m => ({
        equipeA: m.equipeDomicile,
        equipeB: m.equipeExterieur,
        scoreA: m.scoreDomicile,
        scoreB: m.scoreExterieur,
        journee: m.journee
      })) || []
    };
  }

  function renderAll() {
    const html = renderQualifications() + renderGroupes() + renderFinale();
    document.getElementById('content').innerHTML = html;
  }

  function renderQualifications() {
    const confs = {
      'Cath√©sie (16 √©quipes)': {prefix: 'Cath', groupes: ['A','B','C','D'], color: '#7f6000', qualif: '#ffe599', qualPerGroup: 2},
      'Idyl√©nie (24 √©quipes)': {prefix: ['Idy','Idyl√©nie'], groupes: ['A','B','C','D','E','F'], color: '#274e13', qualif: '#b6d7a8', qualPerGroup: 1, has2ndTour: true},
      'Ir√©nie (13 √©quipes)': {prefix: 'Ir√©nie', groupes: ['A','B','C','D'], color: '#741b47', qualif: '#d5a6bd', qualPerGroup: 1},
      'Nouveau Monde (11 √©quipes)': {prefix: 'NM', groupes: ['A','B','C'], color: '#b45f06', qualif: '#f9cb9c', qualPerGroup: 1},
      'Pho√©cie (42 √©quipes)': {prefix: 'Pho√©', groupes: ['A','B','C','D','E','F','G'], color: '#073763', qualif: '#a4c2f4', qualPerGroup: 3}
    };

    let html = '<div class="phase-section"><h2>üìã Phase des Qualifications</h2>';

    Object.entries(confs).forEach(([confName, conf]) => {
      html += `<div class="confederation-header">${confName}</div>`;

      // Tableaux par groupe
      conf.groupes.forEach(gName => {
        const gMatches = data.matches.filter(m => m.journee?.includes(conf.prefix + ' ' + gName) || m.journee?.includes(gName));
        if (gMatches.length > 0) {
          const classement = calcClassement(gMatches);
          html += renderGroupeClassement(classement, `${confName} - Groupe ${gName}`, conf.qualif, conf.qualPerGroup, `${conf.prefix || ''} ${gName}`);
        }
      });

      // 2nd tour Idyl√©nie
      if (conf.has2ndTour) {
        const tour2Matches = data.matches.filter(m => m.journee?.includes('Idyl√©nie 2e tour'));
        if (tour2Matches.length > 0) {
          const classementTour2 = calcClassement(tour2Matches);
          html += renderGroupeClassement(classementTour2, `${confName} - 2√®me Tour (6 √©quipes)`, conf.qualif, 4, 'Idyl√©nie 2e tour');
        }
      }

      // Classement global
      const confMatches = data.matches.filter(m => {
        const prefix = Array.isArray(conf.prefix) ? conf.prefix : [conf.prefix];
        return prefix.some(p => m.journee?.includes(p));
      });
      const classementConf = calcClassement(confMatches);
      html += renderConfClassement(classementConf, conf.color, conf.qualif);
    });

    html += '</div><div class="phase-separator"></div>';
    return html;
  }

  function renderGroupes() {
    let html = '<div class="phase-section"><h2>‚öΩ Phase de Groupes (48 √©quipes)</h2>';

    // 12 groupes G1 √† G12
    for (let i = 1; i <= 12; i++) {
      const gMatches = data.matches.filter(m => m.journee?.includes(`G${i}`) || m.journee?.includes(`Phase de groupes ${i}`));
      if (gMatches.length > 0) {
        const classement = calcClassement(gMatches);
        html += renderGroupeClassement(classement, `Groupe G${i}`, '#a4c2f4', 2, `G${i}`);
      }
    }

    // Classement global phase de groupes
    const allGroupMatches = data.matches.filter(m => m.journee?.includes('PhaseG') || m.journee?.includes('Phase de groupes'));
    const classementGlobal = calcClassement(allGroupMatches);
    html += '<h3 style="background:#073763;color:white;padding:15px;border-radius:10px;margin:30px 0 15px">Phase de Groupes - Classement Global (24 direct + 8 meilleurs 3√®mes)</h3>';
    html += renderGroupesGlobal(classementGlobal);

    html += '</div><div class="phase-separator"></div>';
    return html;
  }

  function renderFinale() {
    const finalMatches = data.matches.filter(m =>
      m.journee?.includes('Seizi√®mes') || m.journee?.includes('Huiti√®mes') ||
      m.journee?.includes('Quarts') || m.journee?.includes('Demi') || m.journee?.includes('Finale')
    );

    const groupMatches = data.matches.filter(m => m.journee?.includes('PhaseG') || m.journee?.includes('Phase de groupes'));
    const classementFinal = calcClassementFinal(finalMatches, groupMatches);

    let html = '<div class="phase-section"><h2>ü•á Phase Finale (32 √©quipes)</h2>';
    html += renderPhaseFinaleGlobal(classementFinal);
    html += '</div>';
    return html;
  }

  function renderGroupeClassement(classement, titre, qualifColor, qualCount, matchFilter) {
    let html = `<h4>${titre}</h4>`;
    html += '<table class="classement-table">';
    html += '<thead><tr><th>#</th><th>Pays</th><th style="font-weight:800">PTS</th><th>J</th><th>G</th><th>N</th><th>P</th><th>BP</th><th>BC</th><th>Diff</th></tr></thead><tbody>';

    classement.slice(0, 8).forEach((team, i) => {
      const qualifie = i < qualCount;
      html += `<tr${qualifie ? ` style="background:${qualifColor}" class="qualifie"` : ''}>
        <td>${i+1}</td>
        <td>${team.nom}</td>
        <td class="points">${team.pts}</td>
        <td>${team.j}</td>
        <td>${team.g}</td>
        <td>${team.n}</td>
        <td>${team.p}</td>
        <td>${team.bp}</td>
        <td>${team.bc}</td>
        <td>${team.diff >= 0 ? '+' : ''}${team.diff}</td>
      </tr>`;
    });

    html += '</tbody></table>';

    // Bouton pour tous les matchs du groupe
    const matchesId = 'matches-' + Math.random().toString(36).slice(2);
    groupMatches[matchesId] = data.matches.filter(m => m.journee?.includes(matchFilter));
    html += `<button class="btn" onclick="toggleMatches('${matchesId}', this)">üì∫ Voir tous les matchs (${groupMatches[matchesId].length})</button>
             <div id="${matchesId}" class="matches-section"></div>`;

    return html;
  }

  function renderConfClassement(classement, headerColor, qualifColor) {
    let html = '<table class="classement-table">';
    html += '<thead><tr><th>#</th><th>Pays</th><th style="font-weight:800">PTS</th><th>J</th><th>G</th><th>N</th><th>P</th><th>BP</th><th>BC</th><th>Diff</th><th>Statut</th></tr></thead><tbody>';

    classement.slice(0, 20).forEach((team, i) => {
      const qualifie = i < 8;
      html += `<tr${qualifie ? ` style="background:${qualifColor}" class="qualifie"` : ''}>
        <td>${i+1}</td>
        <td>${team.nom}</td>
        <td class="points">${team.pts}</td>
        <td>${team.j}</td>
        <td>${team.g}</td>
        <td>${team.n}</td>
        <td>${team.p}</td>
        <td>${team.bp}</td>
        <td>${team.bc}</td>
        <td>${team.diff >= 0 ? '+' : ''}${team.diff}</td>
        <td>${qualifie ? '<strong style="color:#1c3a72">Qualifi√©</strong>' : ''}</td>
      </tr>`;
    });

    html += '</tbody></table>';
    return html;
  }

  function renderGroupesGlobal(classement) {
    let html = '<table class="classement-table groupes">';
    html += '<thead><tr><th>#</th><th>Gpe</th><th>Pays</th><th style="font-weight:800">PTS</th><th>J</th><th>G</th><th>N</th><th>P</th><th>BP</th><th>BC</th><th>Diff</th><th>Parcours</th><th>Statut</th></tr></thead><tbody>';

    classement.slice(0, 48).forEach((team, i) => {
      const qualifie = i < 32;
      const groupe = `G${Math.floor(i/4)+1}`;
      html += `<tr${qualifie ? ` style="background:#a4c2f4" class="qualifie"` : ''}>
          <td>${i+1}</td>
          <td>${groupe}</td>
          <td>${team.nom}</td>
          <td class="points">${team.pts}</td>
          <td>${team.j}</td>
          <td>${team.g}</td>
          <td>${team.n}</td>
          <td>${team.p}</td>
          <td>${team.bp}</td>
          <td>${team.bc}</td>
          <td>${team.diff >= 0 ? '+' : ''}${team.diff}</td>
          <td>${groupe} ${i%4+1}</td>
          <td>${qualifie ? '<strong style="color:#1c3a72">Qualifi√© 1/16</strong>' : '<strong style="color:#e85d5d">√âlimin√©</strong>'}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      return html;
    }

    function renderPhaseFinaleGlobal(classement) {
      let html = '<table class="classement-table">';
      html += '<thead><tr><th>#</th><th>Pays</th><th style="font-weight:800">PTS</th><th>G</th><th>N</th><th>P</th><th>BP</th><th>BC</th><th>Diff</th><th>üü°</th><th>üî¥</th><th>Parcours</th></tr></thead><tbody>';

      classement.forEach((team, i) => {
        const parcoursClass = team.parcours.toLowerCase().replace(/[^a-z]/g, '');
        html += `<tr class="parcours-${parcoursClass}">
          <td>${i+1}</td>
          <td><strong>${team.nom}</strong></td>
          <td class="points">${team.pts}</td>
          <td>${team.g}</td>
          <td>${team.n}</td>
          <td>${team.p}</td>
          <td>${team.bp}</td>
          <td>${team.bc}</td>
          <td>${team.diff >= 0 ? '+' : ''}${team.diff}</td>
          <td>${team.jaunes || 0}</td>
          <td>${team.rouges || 0}</td>
          <td><strong>${team.parcours}</strong></td>
        </tr>`;
      });

      html += '</tbody></table>';

      // Bouton pour phase finale
      const finalMatchesId = 'matches-final';
      groupMatches[finalMatchesId] = data.matches.filter(m =>
        m.journee?.includes('Seizi√®mes') || m.journee?.includes('Huiti√®mes') ||
        m.journee?.includes('Quarts') || m.journee?.includes('Demi') || m.journee?.includes('Finale')
      );
      html += `<button class="btn" onclick="toggleMatches('${finalMatchesId}', this)">üì∫ Voir tous les matchs phase finale (${groupMatches[finalMatchesId].length})</button>
               <div id="${finalMatchesId}" class="matches-section"></div>`;

      return html;
    }

    // === FONCTIONS UTILITAIRES ===
    function calcClassement(matches) {
      const table = {};
      matches.forEach(m => {
        const a = table[m.equipeA] || {nom: m.equipeA, pts:0,j:0,g:0,n:0,p:0,bp:0,bc:0,diff:0};
        const b = table[m.equipeB] || {nom: m.equipeB, pts:0,j:0,g:0,n:0,p:0,bp:0,bc:0,diff:0};

        a.j++; b.j++;
        a.bp += m.scoreA; a.bc += m.scoreB; a.diff = a.bp - a.bc;
        b.bp += m.scoreB; b.bc += m.scoreA; b.diff = b.bp - b.bc;

        if (m.scoreA > m.scoreB) { a.g++; a.pts += 3; b.p++; }
        else if (m.scoreA < m.scoreB) { b.g++; b.pts += 3; a.p++; }
        else { a.n++; b.n++; a.pts++; b.pts++; }

        table[m.equipeA] = a; table[m.equipeB] = b;
      });

      return Object.values(table).sort((a,b) =>
        b.pts - a.pts || b.diff - a.diff || b.bp - a.bp || a.nom.localeCompare(b.nom)
      );
    }

    function calcClassementFinal(matches, groupMatches) {
      const table = {};

      // Phase finale
      matches.forEach(m => {
        const a = table[m.equipeA] || {nom:m.equipeA,pts:0,g:0,n:0,p:0,bp:0,bc:0,diff:0,jaunes:0,rouges:0,parcours:'Phase de groupe'};
        const b = table[m.equipeB] || {nom:m.equipeB,pts:0,g:0,n:0,p:0,bp:0,bc:0,diff:0,jaunes:0,rouges:0,parcours:'Phase de groupe'};

        a.bp += m.scoreA; a.bc += m.scoreB; a.diff = a.bp - a.bc;
        b.bp += m.scoreB; b.bc += m.scoreA; b.diff = b.bp - b.bc;

        if (m.scoreA > m.scoreB) { a.g++; a.pts += 3; b.p++; }
        else if (m.scoreA < m.scoreB) { b.g++; b.pts += 3; a.p++; }
        else { a.n++; b.n++; a.pts++; b.pts++; }

        table[m.equipeA] = a; table[m.equipeB] = b;
      });

      // Parcours selon victoires en phase finale
      Object.values(table).forEach(team => {
        const victoiresFinales = matches.filter(m =>
          (m.equipeA === team.nom && m.scoreA > m.scoreB) ||
          (m.equipeB === team.nom && m.scoreB > m.scoreA)
        ).length;

        if (victoiresFinales >= 4) team.parcours = 'Vainqueur 1er ü•á';
        else if (victoiresFinales >= 3) team.parcours = 'Finaliste 2√®me ü•à';
        else if (victoiresFinales >= 2) team.parcours = 'Demi-finales 3/4 ü•â';
        else if (victoiresFinales == 1) team.parcours = 'Quarts de finale 5/8';
        else if (matches.some(m => m.equipeA === team.nom || m.equipeB === team.nom)) team.parcours = 'Huiti√®mes de finale 9/16';
        else if (groupMatches.some(m => m.equipeA === team.nom || m.equipeB === team.nom)) team.parcours = 'Seizi√®mes de finale 17/32';
        else team.parcours = 'Phase de groupe 33/48';
      });

      return Object.values(table).sort((a,b) =>
        b.pts - a.pts || b.diff - a.diff || b.g - a.g || b.bp - a.bp
      );
    }

    // === GESTION MATCHS ===
    function toggleMatches(matchesId, btn) {
      const container = document.getElementById(matchesId);
      const isVisible = container.classList.contains('active');

      if (isVisible) {
        container.classList.remove('active');
        btn.classList.remove('active');
        btn.innerHTML = `üì∫ Voir tous les matchs (${groupMatches[matchesId].length})`;
      } else {
        container.classList.add('active');
        btn.classList.add('active');
        btn.innerHTML = `üìâ Masquer les matchs (${groupMatches[matchesId].length})`;
        container.innerHTML = renderMatchesTable(groupMatches[matchesId]);
      }
    }

    function renderMatchesTable(matches) {
      let html = '<table class="match-table"><thead><tr><th>Journ√©e</th><th>üè† Domicile</th><th>Score</th><th>Ext√©rieur üèÉ</th></tr></thead><tbody>';

      // Trier par journee puis score
      matches.sort((a,b) => a.journee.localeCompare(b.journee) ||
        (b.scoreA + b.scoreB) - (a.scoreA + a.scoreB));

      matches.slice(0, 20).forEach(m => {
        const css = m.scoreA > m.scoreB ? 'match-win' :
                   m.scoreA < m.scoreB ? 'match-loss' : 'match-draw';
        html += `<tr>
          <td style="font-size:0.9em">${m.journee}</td>
          <td>${m.equipeA}</td>
          <td class="${css}" style="font-weight:600">${m.scoreA} - ${m.scoreB}</td>
          <td>${m.equipeB}</td>
        </tr>`;
      });

      if (matches.length > 20) {
        html += `<tr><td colspan="4" style="text-align:center;color:#666;font-style:italic">
          ... et ${matches.length - 20} matchs de plus
        </td></tr>`;
      }

      html += '</tbody></table>';
      return html;
    }
</script>
</body>
</html>
